{"version":3,"file":"useFocusController.js","sources":["../../../../src/components/Combobox/hooks/useFocusController.ts"],"sourcesContent":["import { useEffect } from 'react';\n\nimport { useDidMountEffect, usePreviousValue } from '../../../hooks';\nimport type { UseFocusControllerProps } from '../Combobox.types';\n\nexport const useFocusController = ({\n    controlledRefs: { contentRef, inputHelperRef, inputRef },\n    opened,\n    hasValue,\n    textContent,\n    search,\n    values,\n    readOnly,\n    valueType,\n    closedWithoutChanges,\n    updateSearch,\n    updateFocused,\n    onChipClick,\n}: UseFocusControllerProps) => {\n    const prevSearch = usePreviousValue(search);\n    const prevValues = usePreviousValue(values);\n    const prevOpened = usePreviousValue(opened);\n\n    useDidMountEffect(() => {\n        if (!opened) {\n            updateFocused(false);\n            contentRef.current?.scrollTo({ left: 0 });\n        }\n\n        const hasFocusAfterClose = prevOpened !== undefined && !opened && !closedWithoutChanges?.current;\n\n        if (opened || hasFocusAfterClose) {\n            inputRef.current?.focus();\n        }\n\n        // INFO: Помогает определить, произошло ли закрытие выпадающего меню при выборе значения.\n        // Нужно для того, чтобы не фокусироваться на инпуте\n        // ОЧЕНЬ не нравится это решение, но оно работает\n        if (closedWithoutChanges?.current === false) {\n            closedWithoutChanges.current = true;\n        }\n    }, [opened]);\n\n    useDidMountEffect(() => {\n        const prevValuesCount = prevValues?.length || 0;\n        const valuesCount = values?.length || 0;\n\n        if ((opened || prevOpened) && prevValuesCount < valuesCount) {\n            inputRef.current?.focus();\n        }\n    }, [values, readOnly]);\n\n    useDidMountEffect(() => {\n        if (!inputRef.current) {\n            return;\n        }\n\n        // INFO: Для multiple\n        if (search === '') {\n            inputRef.current.style.flex = '1';\n        }\n\n        // INFO: Для single\n        if (!opened && prevSearch !== search) {\n            inputRef.current.style.flex = '1';\n        }\n\n        // INFO: Для кейсов, когда значение вырезано\n        if (!inputRef.current.value.length) {\n            inputRef.current.style.flex = '1';\n            return;\n        }\n\n        if (valueType === 'multiple' && inputHelperRef.current) {\n            const { clientWidth } = inputHelperRef.current;\n            inputRef.current.style.flex = `1 0 ${clientWidth}px`;\n        }\n    }, [readOnly, search, valueType]);\n\n    useEffect(() => {\n        const newSearch = hasValue ? textContent : '';\n\n        // INFO: Заполнить поле input при первой инициализации\n        if (prevOpened !== undefined && opened) {\n            return;\n        }\n\n        if (valueType === 'single') {\n            updateSearch?.(newSearch, false);\n        }\n\n        if (valueType === 'multiple') {\n            updateSearch?.('', false);\n        }\n    }, [updateSearch, values, opened, hasValue, textContent, valueType]);\n\n    const onClickText = (event: React.MouseEvent<HTMLButtonElement>) => {\n        onChipClick?.(event);\n        inputRef.current?.focus();\n    };\n\n    const onFocusInput = () => {\n        if (readOnly) {\n            return;\n        }\n\n        // INFO: Жёсткий хак, нужный для корректного выделения всей строки после выбора значения.\n        // Проблема возникает из-за очередности срабатывания useEffect, который сначала вызывает фокус\n        // на элемент, а потом обновляет состояние inputRef\n        if (valueType === 'single') {\n            setTimeout(() => {\n                inputRef.current?.select();\n            });\n        }\n\n        contentRef.current?.scrollTo({ left: contentRef.current?.scrollWidth });\n\n        updateFocused(true);\n    };\n\n    const onBlurInput = () => {\n        if (!opened) {\n            updateFocused(false);\n        }\n    };\n\n    return { onClickText, onFocusInput, onBlurInput } as const;\n};\n"],"names":["useFocusController","_ref","_ref$controlledRefs","controlledRefs","contentRef","inputHelperRef","inputRef","opened","hasValue","textContent","search","values","readOnly","valueType","closedWithoutChanges","updateSearch","updateFocused","onChipClick","prevSearch","usePreviousValue","prevValues","prevOpened","useDidMountEffect","_contentRef$current","current","scrollTo","left","hasFocusAfterClose","undefined","_inputRef$current","focus","prevValuesCount","length","valuesCount","_inputRef$current2","style","flex","value","clientWidth","concat","useEffect","newSearch","onClickText","event","_inputRef$current3","onFocusInput","_contentRef$current2","_contentRef$current3","setTimeout","_inputRef$current4","select","scrollWidth","onBlurInput"],"mappings":"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"}