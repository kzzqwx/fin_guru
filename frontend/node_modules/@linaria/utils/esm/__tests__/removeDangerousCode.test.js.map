{"version":3,"file":"removeDangerousCode.test.js","names":["parseSync","generate","traverse","dedent","removeDangerousCode","run","code","ast","filename","presets","Error","Program","path","describe","it","expect","toBeDefined","result","toMatchSnapshot"],"sources":["../../src/__tests__/removeDangerousCode.test.ts"],"sourcesContent":["import { parseSync } from '@babel/core';\nimport generate from '@babel/generator';\nimport traverse from '@babel/traverse';\nimport dedent from 'dedent';\n\nimport { removeDangerousCode } from '../removeDangerousCode';\n\nconst run = (code: TemplateStringsArray) => {\n  const ast = parseSync(dedent(code), {\n    filename: 'test.tsx',\n    presets: ['@babel/preset-typescript', '@babel/preset-react'],\n  });\n\n  if (!ast) {\n    throw new Error('Failed to parse');\n  }\n\n  traverse(ast, {\n    Program(path) {\n      removeDangerousCode(path);\n    },\n  });\n\n  return generate(ast).code;\n};\n\ndescribe('removeDangerousCode', () => {\n  it('should be defined', () => {\n    expect(removeDangerousCode).toBeDefined();\n  });\n\n  it('should remove `window` but keep `setVersion` function untouched', () => {\n    const result = run`\n      let _win = undefined;\n\n      try {\n        _win = window;\n      } catch (e) {\n        /* no-op */\n      }\n      export function setVersion(packageName, packageVersion) {\n        if (typeof _win !== 'undefined') {\n          return null;\n        }\n      }\n    `;\n\n    expect(result).toMatchSnapshot();\n  });\n\n  it('should replace body of react component with null', () => {\n    const result = run`\n      export var Popup = /*#__PURE__*/function () {\n        var Popup = function Popup() {\n          var name = Popup.displayName;\n          return <div>{name}</div>;\n        };\n\n        Popup.displayName = 'Popup';\n\n        return Popup;\n      }();\n    `;\n\n    expect(result).toMatchSnapshot();\n  });\n\n  it('should simplify ternary operator', () => {\n    expect(run`\n      export function getHostname(opts) {\n        return typeof location !== \"undefined\" ? location.hostname : \"localhost\";\n      }\n    `).toMatchSnapshot();\n\n    expect(run`\n      export function getHostname(opts) {\n        return location.hostname ? \"location.hostname\" : \"localhost\";\n      }\n    `).toMatchSnapshot();\n\n    expect(run`\n      export function getHostname(opts) {\n        return opts ? \"localhost\" : location.hostname;\n      }\n    `).toMatchSnapshot();\n\n    expect(run`\n      export function getHostname(opts) {\n        return opts ? location.hostname : \"localhost\";\n      }\n    `).toMatchSnapshot();\n  });\n\n  it('should simplify OR expression', () => {\n    const result = run`\n      export function getHostname(opts) {\n        return opts.hostname || location.hostname;\n      }\n    `;\n\n    expect(result).toMatchSnapshot();\n  });\n\n  it('should remove code under is-it-browser checks', () => {\n    const result = run`\n      let method;\n\n      if (typeof window !== 'undefined') {\n        console.log('it is browser');\n        method = window.fetch;\n      }\n\n      if (typeof window === 'undefined') {\n        console.log('it is not browser');\n        method = fetch;\n      }\n\n      export function testFn(arg) {\n        method(arg);\n      }\n    `;\n\n    expect(result).toMatchSnapshot();\n  });\n\n  it('should simplify if statement', () => {\n    const result = run`\n      if (typeof window !== 'undefined') {\n        console.log('it is browser');\n      }\n\n      if (typeof window === 'undefined') {\n        console.log('it is not browser');\n      }\n\n      if (typeof window === 'undefined') {\n        console.log('it is not browser');\n      } else {\n        console.log('it is browser');\n      }\n\n      if (typeof window !== 'undefined') {\n        console.log('it is browser');\n      } else {\n        console.log('it is not browser');\n      }\n    `;\n\n    expect(result).toMatchSnapshot();\n  });\n\n  it('should not remove class', () => {\n    const result = run`\n      class Test {\n        constructor() {\n          window.fetch();\n        }\n      }\n    `;\n\n    expect(result).toMatchSnapshot();\n  });\n});\n"],"mappings":"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"}