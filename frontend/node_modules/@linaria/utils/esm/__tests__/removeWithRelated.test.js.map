{"version":3,"file":"removeWithRelated.test.js","names":["join","babel","generator","dedent","removeWithRelated","File","run","rawCode","code","filename","__dirname","ast","parse","babelrc","configFile","presets","file","visitor","path","node","leadingComments","length","value","trim","comment","listKey","key","prevNode","getSibling","trailingComments","includes","filter","c","traverse","Expression","Statement","describe","it","expect","toMatchSnapshot","toBe"],"sources":["../../src/__tests__/removeWithRelated.test.ts"],"sourcesContent":["/* eslint-env jest */\nimport { join } from 'path';\n\nimport * as babel from '@babel/core';\nimport type { NodePath } from '@babel/core';\nimport generator from '@babel/generator';\nimport type { File as FileNode } from '@babel/types';\nimport dedent from 'dedent';\n\nimport { removeWithRelated } from '../scopeHelpers';\n\ntype MissedBabelCoreTypes = {\n  File: new (\n    options: { filename: string },\n    file: { ast: FileNode; code: string }\n  ) => { path: NodePath<FileNode> };\n};\n\nconst { File } = babel as typeof babel & MissedBabelCoreTypes;\n\nconst run = (rawCode: TemplateStringsArray) => {\n  const code = dedent(rawCode);\n  const filename = join(__dirname, 'source.ts');\n\n  const ast = babel.parse(code, {\n    babelrc: false,\n    configFile: false,\n    filename,\n    presets: ['@babel/preset-typescript'],\n  })!;\n\n  const file = new File({ filename }, { code, ast });\n\n  const visitor = (path: NodePath) => {\n    if (\n      !path.node.leadingComments?.length ||\n      path.node.leadingComments[0].value.trim() !== 'remove'\n    ) {\n      return;\n    }\n\n    const comment = path.node.leadingComments[0];\n    if (path.listKey && typeof path.key === 'number' && path.key > 0) {\n      const prevNode = path.getSibling(path.key - 1);\n      if (prevNode.node.trailingComments?.includes(comment)) {\n        // eslint-disable-next-line no-param-reassign\n        prevNode.node.trailingComments = prevNode.node.trailingComments?.filter(\n          (c) => c !== comment\n        );\n      }\n    }\n\n    // eslint-disable-next-line no-param-reassign\n    path.node.leadingComments = null;\n\n    removeWithRelated([path]);\n  };\n\n  file.path.traverse({\n    Expression: visitor,\n    Statement: visitor,\n  });\n\n  return generator(file.path.node).code;\n};\n\ndescribe('removeWithRelated', () => {\n  it('should keep alive used import specifier', () => {\n    const code = run`\n      import { a, b } from './source';\n\n      /* remove */a;\n    `;\n\n    expect(code).toMatchSnapshot();\n  });\n\n  it('should remove the whole import', () => {\n    const code = run`\n      import { a } from './source';\n\n      /* remove */a;\n    `;\n\n    expect(code).toMatchSnapshot();\n  });\n\n  it('should remove try/catch block', () => {\n    const code = run`\n      const a = 1;\n\n      try {\n        /* remove */42;\n      } catch (e) {\n      }\n    `;\n\n    expect(code).toMatchSnapshot();\n  });\n\n  it('should optimize logical expression', () => {\n    const code = run`\n      const a = 1;\n      /* remove */const b = 2;\n      const c = 3;\n\n      const res = a && b && c;\n    `;\n\n    expect(code).toMatchSnapshot();\n  });\n\n  it('should shake try/catch', () => {\n    const code = run`\n      {\n        const a = 1;\n        /* remove */const b = 2;\n\n        function c() {\n          try {\n            return a;\n          } catch(e) {\n            return b;\n          }\n        }\n      }\n    `;\n\n    expect(code).toMatchSnapshot();\n  });\n\n  it('should remove node if it becomes invalid after removing its children', () => {\n    const code = run`\n      /* remove */const mode = \"DEV\";\n\n      if (mode !== \"DEV\") {\n      }\n    `;\n\n    expect(code).toMatchSnapshot();\n  });\n\n  it('should not delete params of functions', () => {\n    const code = run`\n      function test(arg) {\n        /* remove */console.log(arg);\n        return null;\n      }\n    `;\n\n    expect(code).toMatchSnapshot();\n  });\n\n  it('should remove functions with empty bodies', () => {\n    const code = run`\n      function container() {\n        function testFn(arg) {\n          /* remove */console.log(arg);\n        }\n\n        const testArrow = (arg) => {\n          /* remove */console.log(arg);\n        }\n      }\n    `;\n\n    expect(code).toBe('function container() {}');\n  });\n\n  it('should not remove top-level functions with empty bodies', () => {\n    const code = run`\n      function testFn(arg) {\n        /* remove */console.log(arg);\n      }\n\n      export const testArrow1 = (arg) => {\n        /* remove */console.log(arg);\n      }\n\n      const testArrow2 = (arg) => (\n        /* remove */testFn = arg\n      )\n\n      export default function testDefaultFn(arg) {\n        /* remove */console.log(arg);\n      }\n    `;\n\n    expect(code).toMatchSnapshot();\n  });\n\n  it('should not remove functions that are assigned to prototype', () => {\n    const code = run`\n      (function() {\n        function SomeClass() {}\n\n        SomeClass.prototype.foo = function foo() {}\n\n        SomeClass.prototype.bar = function bar() {\n          /* remove */console.log(arg);\n        };\n      })();\n    `;\n\n    expect(code).toMatchSnapshot();\n  });\n});\n"],"mappings":"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"}